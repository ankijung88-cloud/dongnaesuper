<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë™ë„¤ìŠˆí¼ - ì£¼ë¬¸/ê²°ì œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <!-- PortOne SDK (Optional for real payment later) -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
</head>

<body>
    <header>
        <a href="index.html" class="logo">ğŸ¥¬ ë™ë„¤ìŠˆí¼</a>
    </header>

    <div class="container">
        <h2>ğŸ’³ ì£¼ë¬¸/ê²°ì œ</h2>

        <!-- Settings Toggle -->
        <div style="text-align:right; margin-bottom:10px;">
            <button onclick="toggleSettings()"
                style="background:none; border:none; text-decoration:underline; color:#888;">âš™ï¸ ê²°ì œ ì„¤ì • (ì‚¬ì—…ììš©)</button>
        </div>

        <div id="settings-area" class="card" style="display:none; border:1px solid var(--primary);">
            <h4>âš™ï¸ í¬íŠ¸ì›(PortOne) ì„¤ì •</h4>
            <p style="font-size:0.8rem;">í¬íŠ¸ì› ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë°œê¸‰ë°›ì€ <strong>ê°€ë§¹ì  ì‹ë³„ì½”ë“œ(Merchant ID)</strong>ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="text" id="merchant-id-input" placeholder="ì˜ˆ: imp00000000"
                style="width:100%; padding:8px; margin-top:5px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="saveSettings()" class="btn btn-secondary"
                style="margin-top:10px; font-size:0.8rem;">ì €ì¥í•˜ê¸°</button>
        </div>

        <div class="card">
            <h3>ì£¼ë¬¸ ì •ë³´</h3>
            <p>ë°›ëŠ” ë¶„: <input type="text" id="buyer-name" placeholder="ì´ë¦„ ì…ë ¥" style="padding:5px; width:150px;"></p>
            <p>ì „í™”ë²ˆí˜¸: <input type="tel" id="buyer-tel" placeholder="010-0000-0000" style="padding:5px; width:150px;"></p>
            <p style="margin-top:5px;">ë°°ë‹¬ ì¥ì†Œ: <span id="mart-place"></span></p>
            <hr>
            <h3>ê²°ì œ ê¸ˆì•¡: <span id="total-price" style="color: var(--secondary);">0ì›</span></h3>
        </div>

        <button onclick="processPayment()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px;">
            ê²°ì œí•˜ê¸°
        </button>
    </div>

    <script src="js/data.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/app.js"></script>
    <script>
        let totalAmount = 0;
        let cartItems = [];

        document.addEventListener('DOMContentLoaded', () => {
            const mart = Storage.getMart();
            if (mart) document.getElementById('mart-place').innerText = mart.region + " (ë§ˆì„íšŒê´€)";

            const cart = Storage.getCart();
            totalAmount = 0;

            for (const [pid, qty] of Object.entries(cart)) {
                const product = DATA.products.find(p => p.id == pid);
                if (product) {
                    totalAmount += product.price * qty;
                    cartItems.push({ name: product.name, qty: qty, price: product.price });
                }
            }
            document.getElementById('total-price').innerText = App.formatCurrency(totalAmount);

            // Load saved Merchant ID
            const savedId = localStorage.getItem('portone_merchant_id');
            if (savedId) document.getElementById('merchant-id-input').value = savedId;
        });

        function toggleSettings() {
            const el = document.getElementById('settings-area');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        function saveSettings() {
            const id = document.getElementById('merchant-id-input').value.trim();
            if (!id) { alert('ì‹ë³„ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            localStorage.setItem('portone_merchant_id', id);
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            toggleSettings();
        }

        function processPayment() {
            const userCode = localStorage.getItem('portone_merchant_id');
            if (!userCode) {
                alert('ê²°ì œë¥¼ ì§„í–‰í•˜ë ¤ë©´ [ê²°ì œ ì„¤ì •]ì—ì„œ ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                toggleSettings();
                return;
            }

            const name = document.getElementById('buyer-name').value;
            const tel = document.getElementById('buyer-tel').value;

            if (!name) { alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!tel) { alert('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            // Initialize PortOne
            if (!window.IMP) { alert('ê²°ì œ ëª¨ë“ˆ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'); return; }
            IMP.init(userCode);

            const merchant_uid = "ORD-" + new Date().getTime();
            const orderTitle = cartItems.length > 1 ?
                `${cartItems[0].name} ì™¸ ${cartItems.length - 1}ê±´` :
                cartItems[0].name;

            // Call PortOne Request Pay
            IMP.request_pay({
                pg: "html5_inicis", // Default PG
                pay_method: "card",
                merchant_uid: merchant_uid,
                name: orderTitle,
                amount: totalAmount,
                buyer_email: "test@example.com", // Optional or Add input
                buyer_name: name,
                buyer_tel: tel,
                m_redirect_url: window.location.href // For mobile redirect return
            }, function (rsp) { // Callback for PC/Mobile web (if not redirected)
                if (rsp.success) {
                    completeOrder(rsp);
                } else {
                    alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. " + rsp.error_msg);
                }
            });
        }

        function completeOrder(paymentData) {
            // Create Order Record
            const order = {
                id: paymentData.merchant_uid,
                imp_uid: paymentData.imp_uid,
                mart: Storage.getMart().name,
                items: cartItems,
                total: totalAmount,
                date: new Date().toLocaleString(),
                status: 'ê²°ì œì™„ë£Œ (PGìŠ¹ì¸)'
            };

            Storage.addOrder(order);
            Storage.setCart({}); // Clear Cart

            alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            window.location.href = 'orders.html';
        }
    </script>
</body>

</html>