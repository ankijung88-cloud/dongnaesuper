{% extends 'base.html' %}

{% block content %}
<h2>ğŸ’³ ì£¼ë¬¸/ê²°ì œ</h2>

<div class="card">
    <h3>ì£¼ë¬¸ ì •ë³´</h3>
    <p>ì£¼ë¬¸ì: {{ user.username }} ({{ user.email }})</p>
    {% if mart %}
    <p>ë°°ë‹¬ë°›ì„ ê³³: {{ mart.region }} (ë§ˆì„íšŒê´€ ì•)</p>
    {% endif %}
    <hr>
    <h3>ê²°ì œ ê¸ˆì•¡: <span style="color: var(--secondary);">{{ total }}ì›</span></h3>
</div>

<button onclick="requestPay()" class="btn btn-primary" style="font-size: 1.2rem; padding: 15px;">
    ê²°ì œí•˜ê¸°
</button>

<!-- PortOne SDK -->
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script>
    const userCode = "{{ portone_merchant_id }}"; // Merchant ID from settings context
    IMP.init(userCode);

    function requestPay() {
        const merchant_uid = "ORD-" + new Date().getTime();

        IMP.request_pay({
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: merchant_uid,
            name: "ë™ë„¤ìŠˆí¼ ì¥ë³´ê¸°",
            amount: {{ total }},
    buyer_email: "{{ user.email }}",
        buyer_name: "{{ user.username }}",
            buyer_tel: "010-0000-0000", // Dummy/User profile
        }, function (rsp) {
        if (rsp.success) {
            // Determine UID based on API response structure (rsp.imp_uid)
            verifyPayment(rsp.imp_uid, rsp.merchant_uid);
        } else {
            alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. " + rsp.error_msg);
        }
    });
    }

    function verifyPayment(imp_uid, merchant_uid) {
        fetch("{% url 'core:payment_complete' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
            body: JSON.stringify({ imp_uid: imp_uid, merchant_uid: merchant_uid })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert("ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    window.location.href = "{% url 'core:order_list' %}";
                } else {
                    alert("ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.message);
                }
            });
    }
</script>
{% endblock %}